<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Delete Dashboard</title>
 <link rel="stylesheet" href="css/adm-del-hou-host.css">
 <style>
    /* UX and New Feature Styles */
    .master-filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: flex-end; /* Aligns items to the bottom */
    }
    .master-filter-bar .input-group {
      display: flex;
      flex-direction: column;
    }
    .master-filter-bar .search-group {
      flex-grow: 1; /* Makes search bar take up remaining space */
    }
    .master-filter-bar label {
      font-size: 0.85em;
      color: #555;
      margin-bottom: 4px;
    }
    .master-filter-bar input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
    }

    .gallery img {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .gallery img:hover {
      transform: scale(1.05);
    }
    .description.collapsed {
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 10; /* Limit to 10 lines */
    }
    .see-more-btn {
      background: none; border: none; color: #007bff;
      cursor: pointer; padding: 5px 0; font-weight: bold;
    }
    .modal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      justify-content: center; align-items: center;
    }
    .modal-content { max-width: 90vw; max-height: 90vh; }
    .close {
      position: absolute; top: 20px; right: 35px;
      color: #f1f1f1; font-size: 40px; font-weight: bold;
      cursor: pointer;
    }
    .spinner {
      border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }
    }
 </style>
</head>
<body>

  <div class="dashboard-container">
    <h2>Admin Delete Dashboard</h2>

    <div class="tabs">
      <button class="tab-btn active" onclick="showTab(event, 'houses')">Houses üè°</button>
      <button class="tab-btn" onclick="showTab(event, 'hostels')">Hostels üõèÔ∏è</button>
    </div>

    <div class="master-filter-bar">
      <div class="input-group">
        <label for="occupancy">People per Room</label>
        <input type="number" id="occupancy" placeholder="e.g., 2" onkeyup="applyFilters()">
      </div>
      <div class="input-group search-group">
        <label for="searchInput">Search by Location or Phone</label>
        <input type="text" id="searchInput" placeholder="e.g., Chitawira or 099..." onkeyup="applyFilters()">
      </div>
    </div>

    <!-- Houses Listing -->
    <div id="houses" class="tab-content">
      <!-- House listings will be dynamically loaded here -->
    </div>

    <!-- Hostels Listing -->
    <div id="hostels" class="tab-content" style="display:none">
      <!-- Hostel listings will be dynamically loaded here -->
    </div>
  </div>

  <!-- Image Viewer Modal -->
  <div id="imageModal" class="modal" onclick="closeModal()">
    <span class="close" onclick="closeModal()">&times;</span>
    <img class="modal-content" id="modalImage">
    </div>
  </div>
  
  <script src="../user/apiConfig.js"></script>
  <script>
    const ADMIN_HOSTEL_API_URL = `${API_BASE_URL}/api/admin/hostels`;
    const ADMIN_HOUSE_API_URL = `${API_BASE_URL}/api/admin/general-houses`;
    const token = localStorage.getItem('token'); // Assuming you store JWT in localStorage

    document.addEventListener('DOMContentLoaded', () => {
      // Set the initial active tab and fetch its data
      document.querySelector('.tab-btn.active').click();
    });

    function showTab(event, tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
      document.getElementById(tabName).style.display = 'block';
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.currentTarget.classList.add('active');

      // Fetch data for the newly active tab
      if (tabName === 'hostels') {
        fetchAndRenderHostels();
      } else if (tabName === 'houses') {
        fetchAndRenderHouses();
      }

      // Clear all filters on tab switch
      document.getElementById('searchInput').value = '';
      document.getElementById('occupancy').value = '';
    }

    async function fetchAndRenderHostels(filters = {}) {
      const container = document.getElementById('hostels');
      container.innerHTML = '<div class="spinner"></div>'; // Show spinner

      try {
        const params = new URLSearchParams();
        if (filters.search) params.append('search', filters.search);
        if (filters.occupancy) params.append('occupancy', filters.occupancy);

        const queryString = params.toString();
        const url = queryString ? `${ADMIN_HOSTEL_API_URL}?${queryString}` : ADMIN_HOSTEL_API_URL;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const hostels = await response.json();
        container.innerHTML = ''; // Clear loading message

        if (hostels.length === 0) {
          container.innerHTML = '<p>No hostels found matching your criteria.</p>';
          return;
        }

        hostels.forEach(hostel => {
          const listingDiv = document.createElement('div');
          listingDiv.className = 'listing';
          listingDiv.dataset.id = hostel._id;

          const photosHTML = hostel.photos.map(photo => `<img src="${photo}" alt="Hostel photo" onclick="openModal(event, '${photo}')">`).join('');

          listingDiv.innerHTML = `
            <h3>${hostel.name}</h3>
            <p><strong>Location:</strong> ${hostel.location}</p>
            <p><strong>Price Per Month:</strong> MWK ${hostel.pricePerMonth.toLocaleString()}</p>
            <p><strong>People Per Room:</strong> ${hostel.peoplePerRoom}</p>
            <p><strong>Description:</strong></p>
            <p class="description" id="desc-${hostel._id}">${hostel.description || 'N/A'}</p>
            <p><strong>Landlord Phone:</strong> ${hostel.landlordPhone}</p>
            <p><strong>Uploader Phone:</strong> ${hostel.uploaderPhone}</p>
            <div class="gallery">
              ${photosHTML}
            </div>
            <button class="delete-btn" onclick="deleteListing(event, this)">Delete Listing</button>
          `;
          container.appendChild(listingDiv);

          // Add 'See More' functionality for the description
          setupCollapsibleText(`desc-${hostel._id}`);
        });

      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = `<p style="color: red;">Error loading hostels: ${error.message}</p>`;
      }
    }

    async function fetchAndRenderHouses(filters = {}) {
      const container = document.getElementById('houses');
      container.innerHTML = '<div class="spinner"></div>';

      try {
        const params = new URLSearchParams();
        if (filters.search) params.append('search', filters.search);
        // Occupancy filter is ignored for houses

        const queryString = params.toString();
        const url = queryString ? `${ADMIN_HOUSE_API_URL}?${queryString}` : ADMIN_HOUSE_API_URL;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const houses = await response.json();
        container.innerHTML = '';

        if (houses.length === 0) {
          container.innerHTML = '<p>No houses found matching your criteria.</p>';
          return;
        }

        houses.forEach(house => {
          const listingDiv = document.createElement('div');
          listingDiv.className = 'listing';
          listingDiv.dataset.id = house._id;

          const photosHTML = house.photos.slice(0, 2).map(photo => `<img src="${photo}" alt="House photo" onclick="openModal(event, '${photo}')">`).join('');

          listingDiv.innerHTML = `
            <h3>House in ${house.area}</h3>
            <p><strong>District:</strong> ${house.district}</p>
            <p><strong>Cost:</strong> MWK ${house.cost.toLocaleString()}</p>
            <p><strong>Description:</strong></p>
            <p class="description" id="desc-house-${house._id}">${house.description || 'N/A'}</p>
            <p><strong>Landlord Phone:</strong> ${house.landlordPhone}</p>
            <p><strong>Uploader Phone:</strong> ${house.uploaderPhone}</p>
            <div class="gallery">
              ${photosHTML}
            </div>
            <button class="delete-btn" onclick="deleteListing(event, this)">Delete Listing</button>
          `;
          container.appendChild(listingDiv);
          setupCollapsibleText(`desc-house-${house._id}`);
        });
      } catch (error) {
        console.error('Error:', error);
        container.innerHTML = `<p style="color: red;">Error loading houses: ${error.message}</p>`;
      }
    }

    async function deleteListing(event, btn) {
      event.stopPropagation(); // Prevent modal from opening if delete is clicked
      const listing = btn.closest('.listing');
      const id = listing.dataset.id;
      const type = listing.parentElement.id; // 'hostels' or 'houses'

      if(confirm('Are you sure you want to delete this listing?')) {
        try {
          let url;
          if (type === 'hostels') {
            url = `${ADMIN_HOSTEL_API_URL}/${id}`;
          } else if (type === 'houses') {
            url = `${ADMIN_HOUSE_API_URL}/${id}`;
          } else {
            throw new Error('Unknown listing type.');
          }

          const response = await fetch(url, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || 'Failed to delete listing.');
          }

          listing.remove();
          alert('Listing deleted successfully.');

        } catch (error) {
          console.error('Delete error:', error);
          alert(`Error deleting listing: ${error.message}`);
        }
      }
    }

    function applyFilters() {
      const filters = {
        search: document.getElementById('searchInput').value,
        occupancy: document.getElementById('occupancy').value
      };

      const activeTab = document.querySelector('.tab-content:not([style*="display: none"])');
      if (activeTab.id === 'hostels') {
        fetchAndRenderHostels(filters);
      } else if (activeTab.id === 'houses') {
        fetchAndRenderHouses(filters);
      }
      // Add else if for houses when implemented
    }

    function openModal(event, src) {
      event.stopPropagation();
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modalImg.src = src;
      modal.style.display = 'flex';
    }

    function closeModal() {
      const modal = document.getElementById('imageModal');
      modal.style.display = 'none';
    }

    function setupCollapsibleText(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;

        // Check if text is long enough to need collapsing
        const lineCount = element.scrollHeight / parseFloat(getComputedStyle(element).lineHeight);
        
        if (lineCount > 10) { // Corresponds to -webkit-line-clamp: 10
            element.classList.add('collapsed');
            const seeMoreBtn = document.createElement('button');
            seeMoreBtn.className = 'see-more-btn';
            seeMoreBtn.textContent = 'See More';
            
            element.parentNode.insertBefore(seeMoreBtn, element.nextSibling);

            seeMoreBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                element.classList.toggle('collapsed');
                const isCollapsed = element.classList.contains('collapsed');
                seeMoreBtn.textContent = isCollapsed ? 'See More' : 'See Less';
            });
        }
    }

  </script>
</body>
</html>
