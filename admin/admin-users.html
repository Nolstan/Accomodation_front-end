<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Admin Users</title>
  <link rel="stylesheet" href="../assets/css/admin-user-page.css">
</head>
<body>
  <h2>Manage Administrators <span id="userCount" style="font-weight: normal; font-size: 0.8em; color: #555;"></span></h2>
  <p style="margin-top: -10px; margin-bottom: 20px; color: #666;">Only superadmins can view this page and perform actions.</p>

  <!-- Search Bar -->
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search by name, email, phone, or location" onkeyup="searchAdmins()" />
  </div>

  <div class="user-list" id="userList">
    <!-- Admin user data will be dynamically loaded here -->
  </div>

  <script src="../configs/apiConfig.js"></script>
  <script>
    const API_ENDPOINT = `${API_BASE_URL}/api/admin/users/admins`;
    const token = localStorage.getItem('token');

    document.addEventListener('DOMContentLoaded', () => {
      fetchAndRenderAdmins();
    });

    async function fetchAndRenderAdmins(searchTerm = '') {
      const userList = document.getElementById('userList');
      userList.innerHTML = '<p>Loading administrators...</p>';

      try {
        const url = searchTerm ? `${API_ENDPOINT}?search=${encodeURIComponent(searchTerm)}` : API_ENDPOINT;
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 403) {
          userList.innerHTML = `<p style="color: red; font-weight: bold;">Access Denied. You must be a superadmin to view this page.</p>`;
          return;
        }
        if (!response.ok) {
          throw new Error(`Failed to fetch admins: ${response.statusText}`);
        }

        const data = await response.json();
        const users = data.users;
        userList.innerHTML = '';

        document.getElementById('userCount').textContent = `(${data.totalUserCount || 0} total)`;

        if (users.length === 0) {
          userList.innerHTML = searchTerm ?
            '<p>No administrators found matching your search.</p>' :
            '<p>No administrators found.</p>';
          return;
        }

        users.forEach(user => {
          const userDiv = document.createElement('div');
          userDiv.className = 'user';
          userDiv.dataset.id = user._id;

          const isSuperAdmin = user.role === 'superadmin';
          const banButtonClass = user.isBanned ? 'unban-btn' : 'ban-btn';
          const banButtonText = user.isBanned ? 'Unban' : 'Ban';
          // Disable buttons for superadmins
          const actionsDisabled = isSuperAdmin ? 'disabled' : '';

          userDiv.innerHTML = `
            <div class="user-info">
              <p><strong>Name:</strong> ${user.username} <span style="color: ${isSuperAdmin ? 'gold' : '#007bff'}; font-weight: bold;">(${user.role})</span></p>
              <p><strong>Email:</strong> ${user.email}</p>
              <p><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
              <p><strong>Location:</strong> ${user.location || 'N/A'}</p>
            </div>
            <div class="actions">
              <button class="btn delete-btn" onclick="deleteAdmin(this)" ${actionsDisabled}>Delete</button>
              <button class="btn ${banButtonClass}" onclick="toggleAdminBan(this)" ${actionsDisabled}>${banButtonText}</button>
            </div>
          `;
          userList.appendChild(userDiv);
        });
      } catch (error) {
        console.error('Error:', error);
        userList.innerHTML = `<p style="color: red;">Error loading administrators: ${error.message}</p>`;
      }
    }

    async function deleteAdmin(btn) {
      const userDiv = btn.closest('.user');
      const userId = userDiv.dataset.id;

      if (confirm('Are you sure you want to permanently DELETE this admin user?')) {
        try {
          const response = await fetch(`${API_ENDPOINT}/${userId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'Failed to delete admin.');
          
          userDiv.remove();
          alert(data.message);
        } catch (error) {
          console.error('Delete error:', error);
          alert(`Error: ${error.message}`);
        }
      }
    }

    async function toggleAdminBan(btn) {
      const userDiv = btn.closest('.user');
      const userId = userDiv.dataset.id;
      const isBanning = btn.classList.contains('ban-btn');

      const action = isBanning ? 'BAN' : 'UNBAN';
      if (confirm(`Are you sure you want to ${action} this admin user?`)) {
        try {
          const response = await fetch(`${API_ENDPOINT}/${userId}/ban`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'Failed to update status.');

          if (isBanning) {
            btn.textContent = 'Unban';
            btn.classList.replace('ban-btn', 'unban-btn');
          } else {
            btn.textContent = 'Ban';
            btn.classList.replace('unban-btn', 'ban-btn');
          }
          alert(data.message);
        } catch (error) {
          console.error('Ban/Unban error:', error);
          alert(`Error: ${error.message}`);
        }
      }
    }

    function searchAdmins() {
      const searchTerm = document.getElementById('searchInput').value;
      fetchAndRenderAdmins(searchTerm);
    }
  </script>
</body>
</html>